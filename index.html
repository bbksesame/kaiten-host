<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Кайтен</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext x='50%25' y='54%25' text-anchor='middle' dominant-baseline='middle' font-size='56'%3E%F0%9F%92%9B%3C/text%3E%3C/svg%3E">
  <!-- скрыть "Новый день" (как у тебя было) -->
  <style>#btnNewDay{display:none !important;}</style>

  <style>
    :root{
      --bg:#151922;--panel:#1d2330;--card:#262f40;--text:#e9edf4;--muted:#a2adbb;--accent:#7aa2ff;
      --ok:#33d17a;--border:#414a60;--dash:#343c52;--timer:#b6f0b6;--btn:#2b3346;--btn-border:#3e4863;--btn-hover:#33405a;
      --danger:#3a1f25;--danger-b:#6c2b37;--card-52:#2a3446;--border-52:#4a6183;--card-22:#342c3a;--border-22:#73507f;
      --pill-shift-bg:#3b3317;--pill-shift-text:#f7e4a2;--pill-time-bg:#442a24;--pill-time-text:#ffd9cd;
      --chip-bg:#222a3b;--chip-border:#51608a;--chip-hover:#2c3650;--card-shadow:0 6px 18px rgba(0,0,0,.25);--card-radius:14px}
    [data-theme="light"]{
      --bg:#f5f7fb;--panel:#ffffff;--card:#ffffff;--text:#0f1625;--muted:#5b6678;--accent:#2b5cff;
      --ok:#2aa36b;--border:#dfe5f2;--dash:#e6ebf5;--timer:#146c2e;--btn:#eef2fb;--btn-border:#d6def0;--btn-hover:#e6ecfa;
      --danger:#fdecef;--danger-b:#f5b3c1;--card-52:#f3f7ff;--border-52:#c5d6ff;--card-22:#fbf1ff;--border-22:#e6c8f0;
      --pill-shift-bg:#fff6cf;--pill-shift-text:#7a6518;--pill-time-bg:#ffe7e1;--pill-time-text:#7a3a2d;
      --chip-bg:#f1f5ff;--chip-border:#c7d4ff;--chip-hover:#e7eeff;--card-shadow:0 4px 14px rgba(0,0,0,.06)}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .topbar{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(21,25,34,.95),rgba(21,25,34,.6));backdrop-filter:blur(6px)}
    [data-theme="light"] .topbar{background:linear-gradient(180deg,rgba(245,247,251,.9),rgba(245,247,251,.6))}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px}.spacer{flex:1}
    button{background:var(--btn);border:1px solid var(--btn-border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    button:hover{background:var(--btn-hover)}.btn-chip{background:var(--chip-bg);border:1px solid var(--chip-border);border-radius:999px;font-weight:600}
    .summarybar{display:flex;flex-wrap:wrap;gap:8px;padding:10px 16px 8px}.chip{display:inline-flex;gap:8px;padding:6px 12px;border:1px solid var(--chip-border);border-radius:999px;cursor:pointer}

    .board{
      display:flex;gap:16px;padding:10px 16px 16px;
      overflow:auto;cursor:default;
      max-height:none;
    }
    .board.grabbing{cursor:grabbing}
    .col{min-width:280px;background:var(--panel);border:1px dashed var(--dash);border-radius:14px;padding:10px;display:flex;flex-direction:column}
    .drop{flex:1;min-height:5500px;padding:6px;border-radius:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--card-radius);padding:10px;margin:8px;cursor:grab;box-shadow:var(--card-shadow)}
    .card.dragging{opacity:.65;transform:scale(.98)}.card.disabled{cursor:not-allowed;opacity:.85}
    .card.shift-52{background:var(--card-52);border-color:var(--border-52)}.card.shift-22{background:var(--card-22);border-color:var(--border-22)}
    .img-hero{margin:-10px -10px 8px}.img-hero img{width:100%;display:block;border-radius:var(--card-radius) var(--card-radius) 0 0;border:0}
    .name{font-weight:700;display:flex;align-items:center;gap:10px}.meta{color:var(--muted);font-size:12px;margin-top:4px}
    .timer{margin-left:auto;font-variant-numeric:tabular-nums;color:var(--timer)}
    .pills{display:flex;align-items:center;gap:8px;margin-top:8px}.pill{display:inline-flex;gap:6px;padding:4px 8px;border-radius:999px;font-size:11px}
    .pill.shift{background:var(--pill-shift-bg);color:var(--pill-shift-text)}.pill.time{background:var(--pill-time-bg);color:var(--pill-time-text)}
    .pill-upload{background:var(--btn);border:1px solid var(--btn-border);color:var(--muted);border-radius:999px;padding:4px 8px}
    .sum{margin-top:8px;font-size:12px;color:var(--muted)} .sum td{padding:2px 0}.sum td:last-child{text-align:right;font-variant-numeric:tabular-nums}
    .footer{padding:8px 16px;color:var(--muted);font-size:12px}.hidden{display:none}

    /* ===== Прогноз — модалка ===== */
    .k-forecast-modal{position:fixed;inset:0;display:none;z-index:9999}
    .k-forecast-modal[aria-hidden="false"]{display:block}
    .k-forecast-backdrop{position:absolute;inset:0;background:rgba(7,10,18,.55)}
    .k-forecast-panel{position:relative;max-width:880px;margin:6vh auto;background:#121829;color:#e8eef9;border:1px solid #2a3550;border-radius:16px;box-shadow:0 16px 56px rgba(0,0,0,.4);overflow:hidden}
    .k-forecast-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #2a3550}
    .k-forecast-close{background:transparent;color:#9fb2d1;border:0;font-size:24px;cursor:pointer;line-height:1}
    .k-forecast-body{padding:16px}
    .kf-mode-row{display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap}
    .kf-mode-btn{padding:5px 14px;border-radius:20px;border:1px solid #2a3550;background:transparent;color:#9fb2d1;cursor:pointer;font-size:13px;transition:background .15s,color .15s}
    .kf-mode-btn.active{background:#2563eb;border-color:#2563eb;color:#fff}
    .kf-date-select{background:#0d1424;border:1px solid #2a3550;color:#e8eef9;border-radius:8px;padding:5px 10px;font-size:13px;cursor:pointer;display:none}
    .kf-date-select.visible{display:inline-block}
    .kf-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .kf-card{background:#0f1420;border:1px solid #22304e;border-radius:12px;padding:12px;min-height:92px;display:flex;flex-direction:column;gap:8px}
    .kf-title{font-size:12px;color:#9fb2d1}
    .kf-val{font-size:26px;font-weight:800}
    .kf-chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#9fb2d1}
    .kf-ok  .kf-val{color:#28d17a}
    .kf-warn .kf-val{color:#ffb020}
    .kf-bad .kf-val{color:#ff6b6b}
    .kf-mute .kf-val{color:#9fb2d1}
    .kf-spinner-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:36px 16px;gap:14px}
    .kf-spinner{width:38px;height:38px;border:3px solid #2a3550;border-top-color:#60a5fa;border-radius:50%;animation:kf-spin .7s linear infinite}
    .kf-spinner-text{font-size:13px;color:#6b7fa3}
    @keyframes kf-spin{to{transform:rotate(360deg)}}
    .kf-csat-breakdown{display:flex;gap:6px;flex-wrap:wrap;margin-top:2px}
    .kf-csat-pill{display:inline-flex;align-items:center;gap:3px;font-size:11px;padding:2px 6px;border-radius:10px;background:#1a2540;color:#9fb2d1;font-weight:600}
    .kf-csat-pill.pill-bad{background:#3b1a1a;color:#ff8080}
    .kf-csat-pill.pill-warn{background:#2e2210;color:#ffb020}
    .kf-csat-pill.pill-ok{background:#102a1f;color:#28d17a}
    .kf-row{
  display:flex;
  align-items:center;
  gap:6px;              /* расстояние между подписью и значением */
}

/* отдельно выровняем строку с датой вправо */
.kf-row.kf-row-updated{
  justify-content:flex-end;
}


  </style>
</head>
<body data-theme="dark">


<!-- LOGIN -->
<div id="login">
  <div class="box" style="max-width:420px;margin:80px auto;background:var(--panel);border:1px dashed var(--dash);border-radius:14px;padding:18px">
    <h1 style="margin:0 0 8px 0;font-size:20px">Вход по коду</h1>
    <p style="margin:0 0 12px 0;color:var(--muted)">Введите ваш 6-значный код доступа.</p>
    <div style="display:flex;gap:8px">
      <input id="codeInput" inputmode="numeric" pattern="\\d{6}" maxlength="6" placeholder="000000"
             style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--btn-border);background:var(--card);color:var(--text)"/>
      <button id="btnDoLogin">Войти</button>
    </div>
  </div>
</div>

<!-- TOP -->
<div id="topbar" class="topbar hidden">
  <header>
    <div>Вы: <span id="who">…</span> <span class="badge" id="roleBadge">Оператор</span></div>
    <div class="spacer"></div>
    <button id="btnTheme" class="btn-chip" title="Переключить тему">Тема: тёмная</button>
    <button id="btnNewDay" class="btn-chip hidden">Новый день</button>
    <button id="btnReports" class="btn-chip hidden">Отчёты</button>
    <button id="btnAutoOut" class="btn-chip hidden">Авто-выход</button>

    <!-- Кнопка ПРОГНОЗ в правом верхнем углу -->
    <button id="k-forecast-btn" class="btn-chip">Прогноз</button>
    <button id="btnLogout" class="btn-chip">Выйти</button>
  </header>
  <div id="summary" class="summarybar hidden"></div>
</div>

<!-- BOARD -->
<div id="appBoard" class="board hidden"></div>
<div id="appFooter" class="footer hidden">Перетаскивайте карточки между колонками. Панорамирование: зажмите ЛКМ в пустой области и тяните.</div>

<!-- REPORTS -->
<div id="reports" class="hidden" style="padding:16px">
  <div class="panel" style="background:var(--panel);border:1px dashed var(--dash);border-radius:14px;padding:12px;margin-bottom:12px">
    <label>Период:</label>
    <input type="date" id="repFrom"> — <input type="date" id="repTo" style="margin-right:12px">
    <label>Оператор:</label> <select id="repOperator" style="margin-right:12px"><option value="">Все</option></select>
    <label>Тимлид:</label> <select id="repTeamlead" style="margin-right:12px"><option value="">Все</option></select>
    <button id="btnBuildRep" class="btn-chip">Сформировать</button>
    <span id="repStatus" style="margin-left:8px;color:var(--muted)"></span>
  </div>
  <div class="panel" style="background:var(--panel);border:1px dashed var(--dash);border-radius:14px;padding:12px">
    <table id="repTable" style="width:100%;border-collapse:collapse">
      <thead>
        <tr>
          <th style="text-align:left;padding:6px;border-bottom:1px solid var(--border)">Оператор</th>
          <th style="text-align:left;padding:6px;border-bottom:1px solid var(--border)">Тимлид</th>
          <th style="text-align:left;padding:6px;border-bottom:1px solid var(--border)">Рабочее</th>
          <th style="text-align:left;padding:6px;border-bottom:1px solid var(--border)">Перерыв</th>
          <th style="text-align:left;padding:6px;border-bottom:1px solid var(--border)">Ожидание</th>
          <th style="text-align:left;padding:6px;border-bottom:1px solid var(--border)">Обед</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- МОДАЛКА ПРОГНОЗ -->
<div id="k-forecast-modal" class="k-forecast-modal" aria-hidden="true">
  <div class="k-forecast-backdrop" data-close></div>
  <div class="k-forecast-panel" role="dialog" aria-modal="true" aria-labelledby="k-forecast-title">
    <div class="k-forecast-head">
      <h3 id="k-forecast-title">Прогноз</h3>
      <button class="k-forecast-close" title="Закрыть" data-close>&times;</button>
    </div>
    <div id="k-forecast-body" class="k-forecast-body"></div>
  </div>
</div>

  
<script>
// Разрешаем работу везде
window.__blocked = false;

/* ====== THEME ====== */
function applyTheme(theme){
  document.body.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
  const btn = document.getElementById('btnTheme');
  if (btn) btn.textContent = 'Тема: ' + (theme==='light' ? 'светлая' : 'тёмная');
}
document.getElementById('btnTheme').onclick = ()=>{
  const next = (document.body.getAttribute('data-theme')==='light') ? 'dark' : 'light';
  applyTheme(next);
};

const state = {
  statuses:[], cards:[], session:null, serverOffsetMs:0, page:'board',
  lastColumnsHash:{},
  localSinceById:{} // локальный старт статуса по id
};

const MAX_DATAURL_LEN = 49000;

// ============ API helper ============
async function api(url, opts={}){
  const r = await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}}, opts));
  if (!r.ok) throw new Error(await r.text());
  return r.headers.get('content-type')?.includes('application/json') ? r.json() : r.text();
}

// ============ Session ============
function applySession(sess){
  state.session = sess;
  document.getElementById('who').textContent = sess?.displayName || sess?.operatorId || '—';
  document.getElementById('roleBadge').textContent = '';
  const isAdmin = sess?.role==='admin';
  document.getElementById('btnNewDay').classList.toggle('hidden', !isAdmin);
  document.getElementById('btnReports').classList.toggle('hidden', !isAdmin);
  document.getElementById('btnAutoOut').classList.toggle('hidden', !isAdmin);
}
async function restoreSession(){
  const token = localStorage.getItem('token');
  if (!token) return null;
  try { return await api('/session.php?token='+encodeURIComponent(token)); } catch { return null; }
}

// ============ Login ============
// сохраняем 6-значный код в localStorage ('kaiten_code') — нужен модалке «Прогноз»
document.getElementById('btnDoLogin').onclick = async ()=>{
  const code = (document.getElementById('codeInput').value||'').trim();
  try{
    const sess = await api('/login.php',{method:'POST',body:JSON.stringify({code})});
    localStorage.setItem('token', sess.token);
    localStorage.setItem('kaiten_code', code);

    applySession(sess);
    document.getElementById('login').style.display='none';
    document.getElementById('topbar').classList.remove('hidden');
    fullReload();
  }catch(e){ alert('Код неверный'); }
};
document.getElementById('btnLogout').onclick = ()=>{
  localStorage.removeItem('token');
  // при желании можно чистить и kaiten_code:
  // localStorage.removeItem('kaiten_code');
  location.reload();
};

// ============ Load/render ============
let __loadCtrl = null;
async function fullReload(){ await load(); }

async function load(){
  if (__loadCtrl) { try{ __loadCtrl.abort(); }catch{} }
  __loadCtrl = new AbortController();
  let data = null;
  try{
    const tok = (state.session && state.session.token) || localStorage.getItem('token') || '';
    const url = tok ? ('/board.php?token=' + encodeURIComponent(tok)) : '/board.php';
    const r = await fetch(url, { headers:{'Content-Type':'application/json'}, signal: __loadCtrl.signal });
    if (!r.ok) throw new Error(await r.text());
    data = await r.json();
  }catch(e){
    if (e.name === 'AbortError') return;
    console.warn('load() failed:', e.message||e);
    return;
  }finally{
    __loadCtrl = null;
  }
  if (!data) return;

  // сбрасываем локальные таймеры, чтобы не было расхождений
  state.localSinceById = {};

  render(data);
}

function render(data){
  state.statuses = data.statuses||[];
state.cards = (data.cards||[]).map(c=>({
  ...c,
  shiftStart: c.shiftStart || ''
}));

   const byStatus = {}; state.statuses.forEach(s=>byStatus[s]=[]);
  (state.cards||[]).forEach(c => (byStatus[c.status]||(byStatus[c.status]=[])).push(c));
  state.statuses.forEach(s=>{
    (byStatus[s]||[]).sort((a,b)=>{
      const ta = a.statusSince ? new Date(a.statusSince).getTime() : 0;
      const tb = b.statusSince ? new Date(b.statusSince).getTime() : 0;
      return (s==='Хочу в перерыв') ? (ta - tb) : (tb - ta);
    });
  });

  renderSummary(byStatus); renderColumns(byStatus); tickTimers();

  document.getElementById('summary').classList.remove('hidden');
  document.getElementById('appBoard').classList.remove('hidden');
  document.getElementById('appFooter').classList.remove('hidden');
}
function renderSummary(byStatus){
  const summary = document.getElementById('summary'); summary.innerHTML='';
  state.statuses.forEach(s=>{
    const chip = document.createElement('div'); chip.className='chip';
    chip.innerHTML = `<span>${s}</span><span class="count">${(byStatus[s]||[]).length}</span>`;
    chip.onclick = async ()=>{
      if (!state.session) return;
      const myId = (state.session.operatorId||'').trim(); if (!myId) return;
      const me = (state.cards||[]).find(x=>String(x.id)===String(myId));
      if (me && me.status === s) return; // не дёргаем бэк, если тот же статус
      await move(myId, s);
    };
    summary.appendChild(chip);
  });
}

setInterval(() => {
  if (!state.session) return;

  // если скрыт блок доски (и, например, открыт отчёт) — не обновляем
  const boardVisible = !document.getElementById('appBoard')?.classList.contains('hidden');
  if (!boardVisible) return;

  load();
}, 10000);


function hashColumn(cards){ return (cards||[]).map(c=>c.id+':' + (c.statusSince||'')).join('|'); }
function renderColumns(byStatus){
  const root = document.getElementById('appBoard');
  if (!root.dataset.ready){
    root.innerHTML='';
    state.statuses.forEach(s=>{
      const col = document.createElement('div'); col.className='col'; col.dataset.status=s;
      col.innerHTML = `<h3.style="margin:6px 8px 10px">${s} <span class="count">0</span></h3><div class="drop" data-status="${s}"></div>`;
      enableDrop(col.querySelector('.drop')); root.appendChild(col);
    });
    root.dataset.ready='1';
  }
  state.statuses.forEach(s=>{
    const cards = byStatus[s]||[]; const newHash = hashColumn(cards);
    const col = root.querySelector(`.col[data-status="${s.replace(/"/g,'\\"')}"]`); if (!col) return;
    col.querySelector('.count').textContent = String(cards.length);
    if (state.lastColumnsHash[s] === newHash) return;
    state.lastColumnsHash[s] = newHash;
    const drop = col.querySelector('.drop'); drop.innerHTML='';
    const frag = document.createDocumentFragment();
    cards.forEach(c => frag.appendChild(makeCard(c)));
    drop.appendChild(frag);
  });
  document.querySelectorAll('.card').forEach(renderStartLine);
}
function detectShiftClass(shift){ const s=String(shift||'').toLowerCase(); if(s==='5/2')return'shift-52'; if(s==='2/2')return'shift-22'; return''; }
function makeCard(c){
  const el = document.createElement('div');
  el.className = 'card ' + detectShiftClass(c.shift);
  const isAdmin = state.session?.role==='admin';
  const sessId = (state.session?.operatorId||'').trim();
  const cardId = String(c.id||'').trim();
  const isOwn = sessId === cardId;
  el.draggable = !!(isAdmin || isOwn); if (!el.draggable) el.classList.add('disabled');
  el.dataset.id = cardId; el.dataset.status = c.status;
  if (c.statusSince) el.dataset.since = c.statusSince; if (c.shiftStart) el.dataset.shiftStart = c.shiftStart;
  const t = c.totals||{}; el.dataset.totalLine=t.totalLine||0; el.dataset.totalBreak=t.totalBreak||0; el.dataset.totalWait=t.totalWait||0; el.dataset.totalLunch=t.totalLunch||0;
  const avatar = (c.images&&c.images.length)?c.images[c.images.length-1]:'';//
  el.innerHTML =
    (avatar?`<div class="img-hero"><img src="${avatar}"></div>`:'')+
    `<div class="name"><div>${esc(c.name)}</div><span class="timer"></span></div>`+
    `<div class="meta">${c.role==='admin'?'<span class="tag">Админ</span>':''}</div>`+
    `<div class="pills">
       ${c.shift?`<span class="pill shift">${esc(c.shift)}</span>`:''}
       ${c.workHours?`<span class="pill time">${esc(c.workHours)}</span>`:''}
       <button class="pill-upload" type="button">+ фото</button>
     </div>`+
    `<div class="sum"><table>
       <tr><td>Рабочее время</td><td class="sum-line">00:00</td></tr>
       <tr><td>Перерыв</td><td class="sum-break">00:00</td></tr>
       <tr><td>Ожидание</td><td class="sum-wait">00:00</td></tr>
       <tr><td>Обед</td><td class="sum-lunch">00:00</td></tr>
     </table></div>
     <div class="startline"><span class="start-text"></span></div>`;
  el.querySelector('.pill-upload').onclick = ()=> triggerAddImage(cardId);
  el.addEventListener('dragstart', e=>{
    if(!el.draggable){e.preventDefault();return;}
    el.classList.add('dragging');
    e.dataTransfer.setData('text/plain', cardId);
    __asStart();
  });
  el.addEventListener('dragend', ()=>{
    el.classList.remove('dragging');
    __asStop();
  });
  renderStartLine(el);
  return el;
}
function enableDrop(zone){
  zone.addEventListener('dragover', e=>{
    e.preventDefault();
    zone.style.outline='2px dashed var(--accent)';
    __asUpdateMouse(e);
  });
  zone.addEventListener('dragleave', ()=> zone.style.outline='none');
  zone.addEventListener('drop', async e=>{
    e.preventDefault(); zone.style.outline='none';
    const id = (e.dataTransfer.getData('text/plain')||'').trim(); if(!id) return;
    const to = zone.dataset.status;
    const card = (state.cards||[]).find(x=>String(x.id)===String(id));
    if (card && card.status === to) return; // не сбрасываем таймеры
    await move(id,to);
  });
}
async function move(operatorId, newStatus){
  if (!state.session) return;
  const id = String(operatorId||'').trim(); if (!id) return;
  const cur = (state.cards||[]).find(x=>String(x.id)===String(id));
  if (cur && cur.status === newStatus) return;
  if (newStatus==='Выходной' && !confirm('Перевести в «Выходной»? Будут сброшены итоги и старт смены.')) return;

  try{
    const nowMs  = Date.now();
    const nowIso = new Date(nowMs).toISOString();

    await api('/move.php',{
      method:'POST',
      body:JSON.stringify({operatorId:id,newStatus,token:state.session.token,note:''})
    });

    // локальный старт таймера по id
    state.localSinceById = state.localSinceById || {};
    state.localSinceById[id] = nowMs;

    if (cur){
      cur.status = newStatus;
      cur.statusSince = nowIso;
      // ВАЖНО: shiftStart не трогаем – им управляет только сервер
    }

    await load();
  }catch(e){
    console.warn('moveCard', e.message);
  }
}

// ============ Images ============
async function triggerAddImage(operatorId){
  if (!state.session) return;
  const input = document.createElement('input'); input.type='file'; input.accept='image/*'; input.style.display='none';
  input.onchange = async ()=>{
    const f = input.files?.[0]; if (!f) return;
    try{
      const dataUrl = await readAndResizeImage(f, 480);
      if (dataUrl.length >= MAX_DATAURL_LEN) { alert('Изображение слишком большое'); return; }
      await api('/addImage.php',{method:'POST',body:JSON.stringify({operatorId, token:state.session.token, dataUrl})});
      await load();
    }catch(e){ console.warn('addImage', e.message); }
    finally{ input.remove(); }
  };
  document.body.appendChild(input); input.click();
}
function readAndResizeImage(file, maxW){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader(); fr.onerror=()=>reject(new Error('FileReader error'));
    fr.onload=()=>{ const img=new Image(); img.onerror=()=>reject(new Error('Bad image')); img.onload=()=>{
      let w=img.width,h=img.height; if(w>maxW){const k=maxW/w; w=Math.max(1,Math.round(w*k)); h=Math.max(1,Math.round(h*k));}
      let quality=0.8, mime='image/webp'; const test=document.createElement('canvas').toDataURL('image/webp',0.5); if(!/^data:image\/webp/i.test(test)) mime='image/jpeg';
      let attempts=0; const minQ=0.4, minW=160;
      while(attempts<40){
        attempts++; const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h; const ctx=cvs.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        let out=cvs.toDataURL(mime,quality); if(!/^data:image\/(webp|jpeg)/i.test(out)){ mime='image/jpeg'; out=cvs.toDataURL(mime,quality); }
        if(out.length<MAX_DATAURL_LEN) return resolve(out);
        if(quality>minQ+1e-3){ quality=Math.max(minQ, +(quality-0.1).toFixed(2)); }
        else if(w>minW){ w=Math.max(minW,Math.round(w*0.85)); h=Math.max(1,Math.round(h*0.85)); quality=0.8; }
        else break;
      }
      reject(new Error('Не удалось ужать изображение'));
    }; img.src=fr.result; };
    fr.readAsDataURL(file);
  });
}

// ============ Timers / sums ============
function tickTimers(){
  if (document.hidden || state.page !== 'board') return;
  const list = document.querySelectorAll('.card'); 
  if (!list.length) return;

  const nowMs = Date.now();

  list.forEach(el=>{
    const st = el.dataset.status;
    const id = String(el.dataset.id || '').trim();
    const sinceAttr = el.dataset.since;

    let runningSec = 0;

    if (st !== 'Выходной') {
      if (id && state.localSinceById && state.localSinceById[id]) {
        runningSec = Math.max(0, Math.floor((nowMs - state.localSinceById[id]) / 1000));
      } else if (sinceAttr) {
        const t = new Date(sinceAttr).getTime();
        if (!Number.isNaN(t) && t <= nowMs) {
          runningSec = Math.max(0, Math.floor((nowMs - t)/1000));
        }
      }
    }

    const timerSpan = el.querySelector('.timer');
    const txt = runningSec ? formatDuration(runningSec) : '';
    if (timerSpan && timerSpan.textContent!==txt) timerSpan.textContent = txt;

    const base = {
      line: Number(el.dataset.totalLine||0),
      brk:  Number(el.dataset.totalBreak||0),
      wait: Number(el.dataset.totalWait||0),
      lunch:Number(el.dataset.totalLunch||0)
    };

    if (st!=='Выходной'){
      switch(st){
        case 'Чаты':
        case 'Хочу в перерыв':
        case 'Звонки':
        case 'Обучение':
          base.line+=runningSec; break;
        case 'Перерыв':
        case 'Перерыв на звонках':
          base.brk+=runningSec; break;
        case 'Ожидание':
        case 'Ожидание Обед':
          base.wait+=runningSec; break;
        case 'Обед':
          base.lunch+=runningSec; break;
      }
    } else {
      base.line=base.brk=base.wait=base.lunch=0;
    }

    renderSums(el, base);
    renderStartLine(el);
  });
}
setInterval(tickTimers, 1000);


function renderSums(el,b){
  const s1=formatDuration(b.line), s2=formatDuration(b.brk), s3=formatDuration(b.wait), s4=formatDuration(b.lunch);
  const a=el.querySelector('.sum-line'); if(a&&a.textContent!==s1)a.textContent=s1;
  const b1=el.querySelector('.sum-break'); if(b1&&b1.textContent!==s2)b1.textContent=s2;
  const c=el.querySelector('.sum-wait'); if(c&&c.textContent!==s3)c.textContent=s3;
  const d=el.querySelector('.sum-lunch'); if(d&&d.textContent!==s4)d.textContent=s4;
}
function formatDuration(totalSec){ totalSec=Math.max(0,Math.floor(totalSec)); const hh=Math.floor(totalSec/3600), mm=Math.floor((totalSec%3600)/60), ss=totalSec%60; const pad=n=>(n<10?'0':'')+n; return (hh>0?pad(hh)+':':'')+pad(mm)+':'+pad(ss); }
function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]); }

function renderStartLine(el){
  const span = el.querySelector('.start-text');
  if (!span) return;

  const status = el.dataset.status || '';
  const s = el.dataset.shiftStart || '';

  // В выходном или при пустом shiftStart ничего не показываем
  if (!s || status === 'Выходной'){
    if (span.textContent!=='') span.textContent='';
    return;
  }

  const d = new Date(s);
  if (isNaN(d.getTime())) {
    if (span.textContent!=='') span.textContent='';
    return;
  }

  const now = new Date();
  const pad = n => (n<10?'0':'')+n;

  const same =
    d.getFullYear()===now.getFullYear() &&
    d.getMonth()===now.getMonth() &&
    d.getDate()===now.getDate();

  const hhmm = pad(d.getHours())+':'+pad(d.getMinutes());

  span.textContent = same
    ? ('Начал смену в '+hhmm)
    : ('Начал смену '+pad(d.getDate())+'.'+pad(d.getMonth()+1)+'.'+d.getFullYear()+' в '+hhmm);
}


/* ============ AutoScroll while dragging (чувствительнее) ============ */
let __asRAF = 0, __asActive = false, __mx = 0, __my = 0;
const __EDGE = 160;
const __MAXSPEED = 64;
function __asUpdateMouse(e){ __mx = e.clientX; __my = e.clientY; if (!__asActive) __asStart(); }
function __asStart(){
  __asActive = true;
  const loop = ()=>{
    __asRAF = requestAnimationFrame(loop);
    const vw = window.innerWidth, vh = window.innerHeight;
    let dx = 0, dy = 0;
    if (__mx < __EDGE) dx = -((__EDGE - __mx)/__EDGE) * __MAXSPEED;
    else if (vw - __mx < __EDGE) dx =  ((__EDGE - (vw - __mx))/__EDGE) * __MAXSPEED;
    if (__my < __EDGE) dy = -((__EDGE - __my)/__EDGE) * __MAXSPEED;
    else if (vh - __my < __EDGE) dy =  ((__EDGE - (vh - __my))/__EDGE) * __MAXSPEED;
    const board = document.querySelector('.board');
    if (board && dx) board.scrollLeft += dx;
    if (dy) {
      if (board && board.scrollHeight > board.clientHeight) board.scrollTop += dy;
      else window.scrollBy(0, dy);
    }
  };
  loop();
}
function __asStop(){ __asActive = false; if (__asRAF) cancelAnimationFrame(__asRAF); __asRAF = 0; }
document.addEventListener('dragover', (e)=>{ __asUpdateMouse(e); });
document.addEventListener('drop', ()=> __asStop());
document.addEventListener('dragleave', (e)=>{
  if (e.clientX<=0 || e.clientY<=0 || e.clientX>=window.innerWidth || e.clientY>=window.innerHeight) __asStop();
});

/* ============ PANNING: перемещение полотна мышью (X+Y) ============ */
(function enablePanning(){
  const board = document.getElementById('appBoard');
  let isDown = false, startX = 0, startY = 0, sl = 0, st = 0;

  board.addEventListener('mousedown', (e)=>{
    if (e.button !== 0) return;
    if (e.target.closest('.card') || /(input|button|select|textarea)/i.test(e.target.tagName)) return;
    isDown = true;
    board.classList.add('grabbing');
    startX = e.clientX; startY = e.clientY;
    sl = board.scrollLeft; st = board.scrollTop;
    e.preventDefault();
  });
  window.addEventListener('mousemove', (e)=>{
    if (!isDown) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    board.scrollLeft = sl - dx;
    if (board.scrollHeight > board.clientHeight) board.scrollTop  = st - dy;
    else {
      window.scrollTo({ top: window.scrollY - dy, left: window.scrollX });
      startY = e.clientY; st = 0;
    }
  });
  const stopPan = ()=>{
    if (!isDown) return;
    isDown = false;
    board.classList.remove('grabbing');
  };
  window.addEventListener('mouseup', stopPan);
  document.addEventListener('mouseleave', stopPan);
})();

// ============ Reports ============
function fillReportSelectors(cards){
  const opSel=document.getElementById('repOperator'), tlSel=document.getElementById('repTeamlead');
  const ops = Array.from(new Set(cards.map(c=>JSON.stringify({id:c.id,name:c.name})))) .map(s=>JSON.parse(s)) .sort((a,b)=>a.name.localeCompare(b.name,'ru'));
  const tls = Array.from(new Set(cards.map(c=>c.teamlead).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ru'));
  opSel.innerHTML='<option value=\"\">Все</option>'+ops.map(o=>`<option value="${esc(o.id)}">${esc(o.name)}</option>`).join('');
  tlSel.innerHTML='<option value=\"\">Все</option>'+tls.map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join('');
  const today = new Date(); const iso=d=>new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  if(!document.getElementById('repFrom').value) document.getElementById('repFrom').value = iso(today);
  if(!document.getElementById('repTo').value)   document.getElementById('repTo').value   = iso(today);
}
document.getElementById('btnBuildRep').onclick = async ()=>{
  const from = document.getElementById('repFrom').value;
  const to   = document.getElementById('repTo').value;
  const op   = document.getElementById('repOperator').value || '';
  const tl   = document.getElementById('repTeamlead').value || '';
  const q = new URLSearchParams({ from, to, operatorId: op, teamlead: tl });
  const statusEl = document.getElementById('repStatus');
  statusEl.textContent='Считаю...';
  try{
    const data = await api(`/report.php?${q.toString()}`);
    const rows = data?.rows || [];
    fillRepTable(rows);
    statusEl.textContent = rows.length ? `Строк: ${rows.length}` : 'Нет данных за период';
  }catch(e){
    console.error('Report API error:', e);
    statusEl.textContent = 'Ошибка при формировании отчёта. Подробности — в консоли.';
  }
};
function secToHMS(s){ s=Math.max(0,Math.floor(s)); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60; const pad=n=>(n<10?'0':'')+n; return (h?pad(h)+':':'')+pad(m)+':'+pad(ss); }
function fillRepTable(rows){
  const tb=document.querySelector('#repTable tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td style="padding:6px;border-bottom:1px solid var(--border)">${esc(r.name||r.operatorId)}</td>
      <td style="padding:6px;border-bottom:1px solid var(--border)">${esc(r.teamlead||'')}</td>
      <td style="padding:6px;border-bottom:1px solid var(--border)">${esc(secToHMS(r.totalLine||0))}</td>
      <td style="padding:6px;border-bottom:1px solid var(--border)">${esc(secToHMS(r.totalBreak||0))}</td>
      <td style="padding:6px;border-bottom:1px solid var(--border)">${esc(secToHMS(r.totalWait||0))}</td>
      <td style="padding:6px;border-bottom:1px solid var(--border)">${esc(secToHMS(r.totalLunch||0))}</td>`;
    tb.appendChild(tr);
  });
}

// ============ Buttons & Page switch ============
document.getElementById('btnReports').onclick = ()=> switchPage(state.page==='reports'?'board':'reports');
document.getElementById('btnNewDay').onclick = async ()=>{
  if (!state.session) return;
  if (!confirm('Начать новый день? Всех переведёт в «Выходной», обнулит итоги и старт смены.')) return;
  const actor = state.session.displayName || state.session.operatorId;
  try{ await api('/api/newDay',{method:'POST',body:JSON.stringify({token:state.session.token, actor})}); await fullReload(); }catch(e){ alert('Нет прав'); }
};
document.getElementById('btnAutoOut').onclick = async ()=>{
  if (!state.session) return;
  try{
    const actor = state.session.displayName || state.session.operatorId || 'admin';
    const res = await api('/auto-out.php',{method:'POST',body:JSON.stringify({force:true, actor})});
    const moved = res?.moved ?? 0;
    const checked = res?.checked ?? 0;
    alert(`Авто-выход: проверено ${checked}, переведено ${moved}`);
    await fullReload();
  }catch(e){
    alert('Не удалось выполнить авто-выход');
  }
};
function switchPage(page){
  state.page=page; const isRep=page==='reports';
  document.getElementById('summary').classList.toggle('hidden',isRep);
  document.getElementById('appBoard').classList.toggle('hidden',isRep);
  document.getElementById('appFooter').classList.toggle('hidden',isRep);
  document.getElementById('reports').classList.toggle('hidden',!isRep);
  if (isRep) stopPolling(); else { fullReload(); ensureBoardPolling(); }
}

// ============ Visibility pause ============
document.addEventListener('visibilitychange', ()=>{
  if (document.hidden) stopPolling();
  else if (state.page === 'board') { fullReload(); ensureBoardPolling(); }
});

// ============ Bootstrap ============
(async function bootstrap(){
  applyTheme(localStorage.getItem('theme') || 'dark');
  const sess = await restoreSession();
  if (sess){
    applySession(sess);
    document.getElementById('login').style.display='none';
    document.getElementById('topbar').classList.remove('hidden');
    await fullReload();
    ensureBoardPolling();
  } else {
    document.getElementById('login').style.display='flex';
  }
})();

/* ======== Автообновление только на доске (10 сек) ======== */
let __pollId = 0;
function ensureBoardPolling(){
  if (state.page !== 'board') return;
  if (!__pollId) __pollId = setInterval(fullReload, 10000);
}
function stopPolling(){
  if (__pollId){ clearInterval(__pollId); __pollId = 0; }
}
</script>

<!-- ЛОГИКА МОДАЛКИ "ПРОГНОЗ" + КАЗИНО -->
<script>
/** ССЫЛКА НА Apps Script (web app, /exec) — замени на свою при необходимости */
const APP_URL = 'https://script.google.com/macros/s/AKfycbwSkBCK7eFWXkWJpAf-UBnAhh1yiFOpknxB0kdLddnCITH7vyDPAwqPQdlCDKLsSd0Y/exec';

/** Читаем код из localStorage (его сохраняем при логине) */
function getUserCode(){ return localStorage.getItem('kaiten_code') || null; }

/** Открыть/закрыть модалку */
function kModal(open){
  document.getElementById('k-forecast-modal').setAttribute('aria-hidden', open ? 'false' : 'true');
}
document.addEventListener('click', (e)=>{
  const t=e.target;
  if (t.matches('#k-forecast-btn')) showForecast();
  if (t.closest('[data-close]')) kModal(false);
});
document.addEventListener('keydown', e => { if(e.key==='Escape') kModal(false); });

/** Хелперы рендера */
function toMMSS(total){ const n=Number(total); if(!isFinite(n)) return ''; const m=Math.floor(n/60),s=n%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
function norm(v){ return (v===null||v===undefined||String(v).trim()==='') ? '—' : String(v); }
function pickStatus(key, raw){
  return 'kf-mute';
}
 
function card(title, value, hint){
  const cls = pickStatus(title, value);
  let shown = value;
  if ((title==='RT'||title==='ART') && value && value!=='—') shown = toMMSS(Number(value));
  return `<div class="kf-card ${cls}"><div class="kf-title">${title}${hint?` <span class="kf-chip">${hint}</span>`:''}</div><div class="kf-val">${norm(shown)}</div></div>`;
}
/** Локализованный вывод времени обновления */
function fmtLocal(iso){
  if (!iso) return '—';
  const d = new Date(iso);
  return d.toLocaleString('ru-RU', { hour12: false });
}

/* ==== Мини-слот-машина (казино) ==== */

/** Основная логика */

// Состояние выбора режима — сохраняется между открытиями модалки
const _forecastState = { mode: 'month', date: null, availableDates: [] };

async function showForecast(){
  const code = getUserCode();
  const body = document.getElementById('k-forecast-body');
  kModal(true);

  if (!code){
    body.innerHTML = `<div class="kf-card kf-bad"><div class="kf-title">Ошибка</div><div class="kf-val">Авторизуйтесь в системе</div></div>`;
    return;
  }

  _renderForecastShell(body);
  await _loadForecastData(body, code);
}

function _renderForecastShell(body){
  const s = _forecastState;
  body.innerHTML = `
    <div class="kf-mode-row">
      <button class="kf-mode-btn ${s.mode==='month'?'active':''}" id="kf-btn-month" onclick="_forecastSwitchMode('month')">Итог месяца</button>
      <button class="kf-mode-btn ${s.mode==='day'?'active':''}"   id="kf-btn-day"   onclick="_forecastSwitchMode('day')">Конкретный день</button>
      <select class="kf-date-select ${s.mode==='day'?'visible':''}" id="kf-date-sel" onchange="_forecastDateChange(this.value)">
        ${s.availableDates.length
          ? s.availableDates.map(d=>`<option value="${d}" ${d===s.date?'selected':''}>${_fmtDateOpt(d)}</option>`).join('')
          : '<option value="">…</option>'}
      </select>
    </div>
    <div id="kf-area"><div class="kf-spinner-wrap"><div class="kf-spinner"></div><div class="kf-spinner-text">Загрузка…</div></div></div>
  `;
}


// Карточка Csat с разбивкой по оценкам
function csatCard(value, breakdown){
  const shown = (value == null || value === '' || value === '—') ? '—' : value;
  let pills = '';
  if (breakdown) {
    const colors = {1:'pill-bad', 2:'pill-bad', 3:'pill-warn', 4:'pill-ok', 5:'pill-ok'};
    pills = '<div class="kf-csat-breakdown">' +
      [1,2,3,4,5].map(n =>
        `<span class="kf-csat-pill ${colors[n]}">★${n} — <b>${breakdown[n]||0}</b></span>`
      ).join('') +
    '</div>';
  }
  return `<div class="kf-card kf-mute"><div class="kf-title">Csat <span class="kf-chip">оценка</span></div><div class="kf-val">${shown}</div>${pills}</div>`;
}

async function _loadForecastData(body, code){
  const area = document.getElementById('kf-area');
  if (area) area.innerHTML = `<div class="kf-spinner-wrap"><div class="kf-spinner"></div><div class="kf-spinner-text">Загрузка…</div></div>`;
  const s = _forecastState;
  try{
    const u = new URL(APP_URL);
    u.searchParams.set('api','personal');
    u.searchParams.set('code', code);
    if (s.mode==='day' && s.date) u.searchParams.set('date', s.date);

    const res = await fetch(u.toString(), {method:'GET', credentials:'omit'});
    const js  = await res.json();
    if (!js.ok) throw new Error(js.error || 'API error');

    // Обновляем список дат и дропдаун
    if (js.availableDates && js.availableDates.length){
      s.availableDates = js.availableDates;
      if (!s.date) s.date = js.availableDates[js.availableDates.length-1];
      const sel = document.getElementById('kf-date-sel');
      if (sel){
        sel.innerHTML = js.availableDates.map(d=>`<option value="${d}" ${d===s.date?'selected':''}>${_fmtDateOpt(d)}</option>`).join('');
        sel.value = s.date;
      }
    }

    const m = js.metrics || {};
    const tiles = [
      csatCard(m['Csat'], js.csatBreakdown),
      card('Capacity',       m['Capacity'],       ''),
      card('Закрыто чатов',  m['Закрыто чатов'],  ''),
      card('RT',             m['RT'],             'сек'),
      card('ART',            m['ART'],            'сек'),
      card('Звонки',         m['Звонки'],         'исход + вход'),
    ];
    if (js.mode !== 'day'){
      tiles.push(card('Баллы', m['Баллы'], 'предварительно без ОКК'));
      tiles.push(card('Место', m['Место'], 'предварительно'));
    }

    const dateLabel = js.mode==='day'
      ? `<span style="color:#60a5fa">${_fmtDateOpt(js.date)}</span>`
      : `<span style="color:#60a5fa">Итог месяца</span>`;

    if (area) area.innerHTML = `
      <div class="kf-row" style="margin-bottom:10px">
        <div class="kf-chip">Оператор</div>
        <div style="font-weight:700">${js.operator}</div>
        <div style="margin-left:auto;font-size:12px;color:#6b7fa3">${dateLabel}</div>
      </div>
      <div class="kf-grid">${tiles.join('')}</div>
      <div class="kf-row" style="margin-top:12px">
        <div class="kf-chip">Дата обновления</div>
        <div>${fmtLocal(js.updatedAt)}</div>
      </div>
    `;
  }catch(err){
    if (area) area.innerHTML = `<div class="kf-card kf-bad"><div class="kf-title">Ошибка</div><div class="kf-val">${err.message}</div></div>`;
  }
}

async function _forecastSwitchMode(mode){
  _forecastState.mode = mode;
  document.getElementById('kf-btn-month')?.classList.toggle('active', mode==='month');
  document.getElementById('kf-btn-day')?.classList.toggle('active',   mode==='day');
  const sel = document.getElementById('kf-date-sel');
  sel?.classList.toggle('visible', mode==='day');

  const body = document.getElementById('k-forecast-body');
  const code = getUserCode();
  if (!body || !code) return;

  if (mode === 'day') {
    // Если список дат ещё не загружен — получаем его запросом без даты
    if (!_forecastState.availableDates.length) {
      const area = document.getElementById('kf-area');
      if (area) area.innerHTML = `<div class="kf-spinner-wrap"><div class="kf-spinner"></div><div class="kf-spinner-text">Загрузка дат…</div></div>`;
      try {
        const u = new URL(APP_URL);
        u.searchParams.set('api','personal');
        u.searchParams.set('code', code);
        const res = await fetch(u.toString(), {method:'GET', credentials:'omit'});
        const js  = await res.json();
        if (js.ok && js.availableDates && js.availableDates.length) {
          _forecastState.availableDates = js.availableDates;
        }
      } catch(e){ /* продолжаем */ }
    }
    // Выбираем последнюю дату если ещё не выбрана
    if (_forecastState.availableDates.length) {
      if (!_forecastState.date) {
        _forecastState.date = _forecastState.availableDates[_forecastState.availableDates.length - 1];
      }
      if (sel) {
        sel.innerHTML = _forecastState.availableDates.map(d =>
          `<option value="${d}" ${d===_forecastState.date?'selected':''}>${_fmtDateOpt(d)}</option>`
        ).join('');
        sel.value = _forecastState.date;
      }
    }
  }

  _loadForecastData(body, code);
}

function _forecastDateChange(val){
  _forecastState.date = val;
  const body = document.getElementById('k-forecast-body');
  const code = getUserCode();
  if (body && code) _loadForecastData(body, code);
}

function _fmtDateOpt(iso){
  if (!iso) return '';
  const d = new Date(iso + 'T00:00:00');
  if (isNaN(d)) return iso;
  return d.toLocaleDateString('ru-RU', {day:'numeric', month:'short', year:'numeric'});
}
</script>



</body>
</html>
